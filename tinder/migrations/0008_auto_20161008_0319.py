# -*- coding: utf-8 -*-
# Generated by Django 1.10.2 on 2016-10-08 03:19
from __future__ import unicode_literals

from django.db import migrations
from pymongo import MongoClient
from tqdm import tqdm


# objects added to database in the migration
added = []

def import_from_mongo(apps, schema_editor):
    """
    Populate database with information from mongodb
    :param apps:
    :param schema_editor:
    :return:
    """
    try:
        client = MongoClient()
        col = client.tinderp.hopefuls
        mentioned_snapchat = col.find({'mentions_snapchat': True})
    except Exception as e:
        print("Unable to retrieve information from MongoDB")
        print(e)

    User = apps.get_model("tinder", "User")

    # map of fields between (Django User : Mongo User)
    fields = {
        'name': 'name',
        'age': 'age',
        'bio': 'bio',
        'distance': 'distance_mi',
        'instagram_username': 'instagram_username',
        'mentions_snapchat': 'mentions_snapchat',
        'mentions_kik': 'mentions_kik',
    }

    for person in tqdm(mentioned_snapchat):

        # populate kwargs from person dictionary
        kwargs = {k: person[v] for k, v in fields.items()}

        # initialize and persist user
        user, created = User.objects.get_or_create(**kwargs)
        user._data = person
        user._photos = person.get('photos', [])

        # add user id to added list
        if created:
            added.append(user.id)


def undo(apps, schema_editor):
    """
    Undo migration.
    :param apps:
    :param schema_editor:
    :return:
    """
    User = apps.get_model('tinder', 'User')
    db_alias = schema_editor.connection.alias
    User.objects.filter(pk__in=added).delete()





class Migration(migrations.Migration):

    dependencies = [
        ('tinder', '0007_remove_user_data'),
    ]

    operations = [
        migrations.RunPython(import_from_mongo, undo)
    ]
